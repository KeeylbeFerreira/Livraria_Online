<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Leitura — Livraria do Ke</title>
  <meta name="description" content="Ambiente de leitura com conforto visual.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@700;900&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">

  <style>
    /* Fallback: iframe nativo */
    .pdf-frame{
      width:100%; height:82vh;
      border:1px solid #e6e8ef; border-radius:12px; background:#fff;
      box-shadow:0 10px 26px rgba(13,42,74,.08);
    }
    .reader-header{ display:flex; align-items:center; gap:.75rem; flex-wrap:wrap }
    .reader-header h2{ margin:0 }
    .reader-meta{ color:var(--muted) }
    .reader-actions{ display:flex; gap:.5rem; flex-wrap:wrap }

    /* Foco */
    body.is-focus .header, body.is-focus .footer { display:none }
    body.is-focus .pdf-frame{ height: calc(100vh - 48px) }
    .reader-shell.is-wide .reader-body{ max-width:none }
    .reader-shell.is-wide .pdf-frame{ height: 88vh }

    /* Quando o Pro estiver visível, esconda o fallback */
    #pro-viewer:not([hidden]) ~ .reader-body { display:none; }

    /* ===== Pro Viewer ===== */
    .pro-viewer{
      position:relative;            /* necessário p/ overlay */
      border:1px solid #e6e8ef; border-radius:12px; overflow:hidden;
      box-shadow:0 10px 26px rgba(13,42,74,.08);
      background:var(--card);
    }
    .pro-controls{
      display:flex; align-items:center; gap:.5rem;
      padding:.5rem; border-bottom:1px solid #e6e8ef;
      background:linear-gradient(180deg, rgba(13,42,74,.04), rgba(13,42,74,.02));
    }
    .btn-ghost{ background:#fff; border:1px solid #e6e8ef; color:var(--ink) }
    .btn-ghost:hover{ box-shadow:var(--ring); border-color:var(--gold) }
    .pro-pager{ display:inline-flex; align-items:center; gap:.35rem; padding:.25rem .6rem; border:1px solid #e6e8ef; border-radius:999px; background:#fff; font-weight:700 }
    .pro-pager .sep{ opacity:.55 }
    .pro-gap{ flex:1 }

    .pro-stage{
      position:relative;
      display:grid; grid-template-columns: 1fr 18px 1fr;
      width:100%; height:calc(82vh - 48px);    /* 48px ~ barra de controles */
      background: radial-gradient(120% 100% at 50% 0%, #eef2f8, #e9edf5);
    }
    .pro-stage .page{ display:grid; place-items:center; overflow:hidden; background:linear-gradient(180deg,#ffffff,#fafafa) }
    .pro-stage canvas{ box-shadow: 0 12px 30px rgba(0,0,0,.20); border-radius: 6px }
    .gutter{ background: linear-gradient(90deg, rgba(0,0,0,.10), rgba(0,0,0,0), rgba(0,0,0,.10)) }
    .pro-stage.fade{ animation: proFade .18s ease }
    @keyframes proFade{ from{opacity:.85; transform:translateY(1px)} to{opacity:1; transform:none} }

    body.is-focus .pro-stage{ height: calc(100vh - 48px - 48px) }
    .reader-shell.is-wide .pro-stage{ height: calc(88vh - 48px) }

    /* Overlay de carregamento (não empurra layout) */
    .pro-loading{
      position:absolute; inset:0; z-index:5;
      display:grid; place-items:center;
      background: linear-gradient(180deg, rgba(13,42,74,.06), rgba(13,42,74,.03));
      color:var(--muted); font-weight:700;
      backdrop-filter: blur(1px);
    }
    .pro-loading[hidden]{ display:none; }

    /* Tema escuro */
    :root[data-theme="dark"] .pro-viewer{ background:#0f172a; border-color:#263150 }
    :root[data-theme="dark"] .pro-controls{ background:#0b1427; border-color:#263150 }
    :root[data-theme="dark"] .btn-ghost{ background:#0f172a; color:#e5e7eb; border-color:#263150 }
    :root[data-theme="dark"] .pro-pager{ background:#0f172a; border-color:#263150; color:#e5e7eb }
    :root[data-theme="dark"] .pro-stage{ background: radial-gradient(120% 100% at 50% 0%, #0d152b, #0a1224) }
    :root[data-theme="dark"] .gutter{ background: linear-gradient(90deg, rgba(255,255,255,.06), rgba(255,255,255,0), rgba(255,255,255,.06)) }
    :root[data-theme="dark"] .pro-stage .page{ background:linear-gradient(180deg,#141b33,#0f172a) }
    :root[data-theme="dark"] .pro-stage canvas{ box-shadow: 0 14px 36px rgba(0,0,0,.55) }
  </style>
</head>
<body>

<header class="header">
  <nav class="nav container" aria-label="Principal">
    <a class="brand" href="Pag01.html">
      <img src="assets/img/logo-livraria.png" alt="Logo Livraria do Ke">
      <span>Livraria do Ke</span>
    </a>

    <button class="burger" id="burger" aria-label="Abrir menu">☰</button>

    <div class="nav-links">
      <a href="Pag01.html">Início</a>
      <a href="Catalogo.html">Catálogo</a>
      <a href="sobre.html">Sobre</a>
      <a href="index.html">Entrar</a>
    </div>

    <div class="nav-cta">
      <button id="theme-toggle" class="btn btn-icon" aria-label="Alternar tema" title="Alternar tema"></button>
      <div id="user-area"></div>
    </div>
  </nav>
</header>

<main class="section">
  <div class="container">
    <div class="reader-shell" id="reader-shell">
      <div class="reader-top">
        <div class="reader-header">
          <a class="btn" href="Catalogo.html">← Voltar</a>
          <h2 id="book-title">Carregando…</h2>
          <span id="book-meta" class="reader-meta">—</span>
        </div>

        <div class="reader-actions">
          <button class="btn" id="focus-toggle" title="Modo foco (F)">Modo foco</button>
          <button class="btn" id="wide-toggle"  title="Largura cheia (W)">Largura cheia</button>
          <button class="btn" id="pro-toggle"   title="Leitor Pro (duas páginas)">Leitor Pro</button>
          <a class="btn btn-outline" id="download-link" href="#" download>Baixar PDF</a>
          <a class="btn" id="newtab-link" href="#" target="_blank" rel="noopener">Abrir em nova aba</a>
        </div>
      </div>

      <!-- ===== Leitor Pro (duas páginas com overlay interno) ===== -->
      <div id="pro-viewer" class="pro-viewer" hidden>
        <!-- overlay não empurra o layout -->
        <div id="pro-loading" class="pro-loading" hidden>Carregando páginas…</div>

        <div class="pro-controls">
          <button class="btn btn-ghost" id="pro-prev" aria-label="Página anterior">‹</button>

          <div class="pro-pager" aria-live="polite">
            <span id="pro-current">—</span>
            <span class="sep">/</span>
            <span id="pro-total">—</span>
          </div>

          <button class="btn btn-ghost" id="pro-next" aria-label="Próxima página">›</button>
          <div class="pro-gap"></div>
          <button class="btn btn-ghost" id="pro-zoom-out" title="Diminuir zoom">–</button>
          <button class="btn btn-ghost" id="pro-zoom-in"  title="Aumentar zoom">+</button>
          <button class="btn btn-ghost" id="pro-fit"      title="Ajuste: Altura/Largura">Ajuste: <strong id="pro-fit-label">Altura</strong></button>
          <button class="btn btn-ghost" id="pro-mode"     title="Uma/duas páginas">Duas páginas</button>
        </div>

        <div class="pro-stage" id="pro-stage" role="group" aria-label="Páginas do documento">
          <div class="page left"><canvas id="pro-left"></canvas></div>
          <div class="gutter" aria-hidden="true"></div>
          <div class="page right"><canvas id="pro-right"></canvas></div>
        </div>
      </div>

      <!-- ===== Fallback: iframe nativo ===== -->
      <div class="reader-body" style="grid-template-columns: 1fr; max-width: 1120px; margin: 0 auto;">
        <section class="reader-main">
          <div style="margin-top:.75rem">
            <iframe id="pdf" class="pdf-frame" title="Leitor de PDF (fallback)"></iframe>
          </div>
        </section>
      </div>
    </div>
  </div>
</main>

<footer class="footer">
  <div class="container cols">
    <div>
      <a class="brand" href="Pag01.html">
        <img src="assets/img/logo-livraria.png" alt="Logo Livraria do Ke">
        <span>Livraria do Ke</span>
      </a>
      <p>Leitura que inspira. Atendimento humanizado e entrega para todo o Brasil.</p>
      <small>© 2025 Livraria do Ke. Todos os direitos reservados.</small>
    </div>

    <div>
      <strong>Links</strong><br>
      <a href="Catalogo.html">Catálogo</a><br>
      <a href="sobre.html">Sobre</a><br>
      <a href="index.html">Entrar</a>
    </div>

    <div>
      <strong>Contato</strong>
      <ul class="contact-list">
        <li class="contact"><img src="assets/img/icone_whats.png" alt="WhatsApp"> (00) 00000-0000</li>
        <li class="contact"><img src="assets/img/icone_gmail.png" alt="E-mail"> contato@livrariadoke.com</li>
      </ul>
    </div>
  </div>
</footer>

<div class="toast" role="status" aria-live="polite"></div>

<script src="js/java.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<script type="module">
  import { BOOKS } from './js/books.js';

  /* Utils */
  const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));
  function normalizePath(file){
    const hasDir = /[\\/]/.test(file);
    const base = hasDir ? file : `assets/books/${file}`;
    const parts = base.split('/'); parts[parts.length-1] = encodeURIComponent(parts[parts.length-1]);
    return parts.join('/');
  }

  /* DOM */
  const params  = new URLSearchParams(location.search);
  const id      = params.get('id');
  const titleEl = document.getElementById('book-title');
  const metaEl  = document.getElementById('book-meta');
  const frame   = document.getElementById('pdf');
  const dlLink  = document.getElementById('download-link');
  const tabLink = document.getElementById('newtab-link');
  const shell   = document.getElementById('reader-shell');

  const proBtn     = document.getElementById('pro-toggle');
  const proWrap    = document.getElementById('pro-viewer');
  const proLoad    = document.getElementById('pro-loading');
  const proStage   = document.getElementById('pro-stage');
  const cvsLeft    = document.getElementById('pro-left');
  const cvsRight   = document.getElementById('pro-right');
  const btnPrev    = document.getElementById('pro-prev');
  const btnNext    = document.getElementById('pro-next');
  const btnZoomIn  = document.getElementById('pro-zoom-in');
  const btnZoomOut = document.getElementById('pro-zoom-out');
  const btnFit     = document.getElementById('pro-fit');
  const btnMode    = document.getElementById('pro-mode');
  const lblFit     = document.getElementById('pro-fit-label');
  const lblCur     = document.getElementById('pro-current');
  const lblTot     = document.getElementById('pro-total');

  /* Livro */
  const book = BOOKS.find(b => b.id === id);
  let pdfPath = null;
  if (!book){
    titleEl.textContent = 'Livro não encontrado';
    metaEl.textContent  = 'Verifique o link ou retorne ao catálogo.';
  } else {
    titleEl.textContent = book.title;
    metaEl.textContent  = `${book.author}${book.genres ? ' • ' + book.genres.join(' • ') : ''}`;
    pdfPath = normalizePath(book.file);
    frame.src = `${pdfPath}#toolbar=0&navpanes=0&view=FitH`;
    dlLink.href = pdfPath; dlLink.setAttribute('download', `${book.title}.pdf`);
    tabLink.href = pdfPath;
    document.title = `${book.title} — Leitura • Livraria do Ke`;
  }

  /* Foco/Largura */
  document.getElementById('focus-toggle').addEventListener('click', () => document.body.classList.toggle('is-focus'));
  document.addEventListener('keydown', (e)=>{ if(e.key.toLowerCase()==='f') document.getElementById('focus-toggle').click(); });
  document.getElementById('wide-toggle').addEventListener('click', () => shell.classList.toggle('is-wide'));
  document.addEventListener('keydown', (e)=>{ if(e.key.toLowerCase()==='w') document.getElementById('wide-toggle').click(); });

  /* ===== Pro Viewer (pdf.js) ===== */
  const pdfjsLib = window['pdfjsLib'];
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

  let pdfDoc=null,total=0,pageIndex=1,spread=true,fitMode='height',zoom=1;
  const isActive = ()=>!proWrap.hasAttribute('hidden');

  function computeScale(vp1, w, h){ return (fitMode==='width' ? w/vp1.width : h/vp1.height) * zoom; }

  async function renderCanvas(pageNum, canvas, w, h){
    const ctx = canvas.getContext('2d');
    if(!pageNum){ canvas.width=canvas.height=20; ctx.clearRect(0,0,20,20); return; }
    const page = await pdfDoc.getPage(pageNum);
    const vp1  = page.getViewport({scale:1});
    const scale= computeScale(vp1, w, h);
    const vp   = page.getViewport({scale});
    const dpr  = window.devicePixelRatio || 1;

    canvas.width  = Math.floor(vp.width  * dpr);
    canvas.height = Math.floor(vp.height * dpr);
    canvas.style.width  = Math.floor(vp.width)  + 'px';
    canvas.style.height = Math.floor(vp.height) + 'px';

    ctx.setTransform(dpr,0,0,dpr,0,0);
    await page.render({canvasContext:ctx, viewport:vp}).promise;
  }

  function currentSpread(){
    if(!spread) return {left:null, right:pageIndex};
    if(pageIndex===1) return {left:null, right:1};
    const left  = (pageIndex%2===0) ? pageIndex : pageIndex-1;
    const right = left+1<=total ? left+1 : null;
    return {left,right};
  }

  async function render(){
    if(!pdfDoc) return;
    proStage.classList.add('fade');
    const perPageW = proStage.clientWidth / (spread?2:1) - 24;
    const availH   = proStage.clientHeight - 16;
    const {left,right} = currentSpread();
    await Promise.all([ renderCanvas(left, cvsLeft, perPageW, availH),
                        renderCanvas(right,cvsRight,perPageW, availH) ]);
    lblCur.textContent = String(right ?? left ?? pageIndex);
    setTimeout(()=>proStage.classList.remove('fade'),120);
  }

  async function enablePro(){
    if(!pdfPath) return;
    frame.hidden = true;
    proWrap.hidden = false;
    proBtn.textContent = 'Sair do Leitor Pro';
    try{
      proLoad.hidden = false;        /* overlay visível, mas sem empurrar layout */
      if(!pdfDoc){
        const task = pdfjsLib.getDocument(pdfPath);
        pdfDoc = await task.promise;
        total  = pdfDoc.numPages;
        lblTot.textContent = total;
        pageIndex = clamp(pageIndex,1,total);
      }
      await render();
    } catch(err){
      console.error(err);
      alert('Não foi possível abrir este PDF no Leitor Pro. Abrirei no modo padrão.');
      disablePro();
    } finally{
      proLoad.hidden = true;         /* some sempre */
    }
  }

  function disablePro(){
    proWrap.hidden = true;
    frame.hidden   = false;
    proBtn.textContent = 'Leitor Pro';
  }

  /* Navegação */
  btnPrev.addEventListener('click', ()=>{ if(!pdfDoc) return; pageIndex = clamp(pageIndex - (spread?2:1), 1, total); if(spread && pageIndex===2) pageIndex=1; render(); });
  btnNext.addEventListener('click', ()=>{ if(!pdfDoc) return; pageIndex = clamp(pageIndex + (spread?2:1), 1, total); render(); });
  btnZoomIn.addEventListener('click',  ()=>{ zoom = clamp(zoom+0.1, .5, 3); render(); });
  btnZoomOut.addEventListener('click', ()=>{ zoom = clamp(zoom-0.1, .5, 3); render(); });
  btnFit.addEventListener('click',     ()=>{ fitMode = (fitMode==='height')?'width':'height'; lblFit.textContent = (fitMode==='height')?'Altura':'Largura'; render(); });
  btnMode.addEventListener('click',    ()=>{ spread = !spread; btnMode.textContent = spread ? 'Duas páginas' : 'Uma página'; render(); });

  document.addEventListener('keydown', (e)=>{
    if(!isActive()) return;
    if(e.key==='ArrowLeft')  btnPrev.click();
    if(e.key==='ArrowRight') btnNext.click();
    if(e.key==='+')          btnZoomIn.click();
    if(e.key==='-')          btnZoomOut.click();
    if(e.key.toLowerCase()==='h') btnFit.click();
    if(e.key.toLowerCase()==='p') btnMode.click();
  });

  window.addEventListener('resize', ()=>{
    clearTimeout(window.__pro_t);
    window.__pro_t = setTimeout(()=>{ if(isActive() && pdfDoc) render(); }, 120);
  });

  proBtn.addEventListener('click', ()=> isActive() ? disablePro() : enablePro());
</script>

</body>
</html>
