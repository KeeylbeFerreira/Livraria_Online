<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Catálogo — Livraria do Ke</title>
    <meta name="description" content="Explore livros por categorias.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@700;900&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
  </head>
  <body>

<header class="header">
  <nav class="nav container" aria-label="Principal">
    <a class="brand" href="Pag01.html">
      <img src="assets/img/logo-livraria.png" alt="Logo Livraria do Ke">
      <span>Livraria do Ke</span>
    </a>
    <button class="burger" id="burger" aria-label="Abrir menu">☰</button>
    <div class="nav-links">
      <a href="Pag01.html">Início</a>
      <a href="Catalogo.html" aria-current="page">Catálogo</a>
      <a href="sobre.html">Sobre</a>
      <a href="index.html">Entrar</a>
    </div>
    <div class="nav-cta">
      <a class="btn btn-outline" href="Pag01.html">Início</a>
    </div>
  </nav>
</header>

<main class="section">
  <div class="container" style="display:grid; gap:1rem">
    <h1 class="sr-only" style="position:absolute;left:-9999px">Catálogo</h1>

    <!-- Busca -->
    <form class="searchbar" role="search" aria-label="Buscar no catálogo" onsubmit="event.preventDefault()">
      <input id="search-books" type="search" placeholder="Busque por título ou autor…" aria-label="Buscar por título ou autor">
      <button class="btn btn-primary" type="button">Buscar</button>
    </form>

    <!-- Chips dinâmicos (gêneros) -->
    <div id="chips" class="chips" aria-label="Categorias"></div>

    <!-- Cards -->
    <section id="catalog-grid" class="grid cols-3" aria-live="polite"></section>
  </div>
</main>

<footer class="footer">
  <div class="container cols">
    <div>
      <a class="brand" href="Pag01.html">
        <img src="assets/img/logo-livraria.png" alt="Logo Livraria do Ke">
        <span>Livraria do Ke</span>
      </a>
      <p>Leitura que inspira. Atendimento humanizado e entrega para todo o Brasil.</p>
      <small>© 2025 Livraria do Ke. Todos os direitos reservados.</small>
    </div>
    <div>
      <strong>Links</strong><br>
      <a href="Catalogo.html">Catálogo</a><br>
      <a href="sobre.html">Sobre</a><br>
      <a href="index.html" aria-current="page">Entrar</a>
    </div>
    <div>
      <strong>Contato</strong><br>
      <a href="mailto:contato@livrariadoke.com">contato@livrariadoke.com</a><br>
      <a href="tel:+550000000000">(00) 00000-0000</a>
    </div>
  </div>
</footer>
<div class="toast" role="status" aria-live="polite"></div>

<!-- Catálogo: usa APENAS os livros do ./js/books.js -->
<script type="module">
  import { BOOKS, generateCoverDataURL } from './js/books.js';

  // menu mobile
  const burger = document.getElementById('burger');
  const links  = document.querySelector('.nav-links');
  burger?.addEventListener('click', () => links.classList.toggle('show'));

  const grid       = document.querySelector('#catalog-grid');
  const chipsWrap  = document.querySelector('#chips');
  const searchInput= document.querySelector('#search-books');

  // estado + leitura/escrita na URL (?q=&genre=)
  const params = new URLSearchParams(location.search);
  const state = {
    q: params.get('q') || '',
    genre: params.get('genre') || 'Todos'
  };
  if (searchInput) searchInput.value = state.q;

  const uniq = (arr) => [...new Set(arr)];
  const allGenres = uniq(BOOKS.flatMap(b => (b.genres || []))).sort();

  function updateURL() {
    const p = new URLSearchParams();
    if (state.q) p.set('q', state.q);
    if (state.genre && state.genre !== 'Todos') p.set('genre', state.genre);
    const qs = p.toString();
    history.replaceState(null, '', qs ? `?${qs}` : location.pathname);
  }

  function renderChips() {
    if (!chipsWrap) return;
    const items = ['Todos', ...allGenres];
    chipsWrap.innerHTML = items.map(g => `
      <button class="chip${g === state.genre ? ' active' : ''}" data-genre="${g}" type="button">${g}</button>
    `).join('');
    chipsWrap.querySelectorAll('[data-genre]').forEach(btn => {
      btn.addEventListener('click', () => {
        chipsWrap.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        state.genre = btn.dataset.genre;
        updateURL();
        renderGrid();
      });
    });
  }

  function cardHTML(b) {
    const cover = b.cover ?? generateCoverDataURL(b.title, b.author);
    return `
      <article class="card" data-id="${b.id}">
        <div class="card-media">
          <img data-id="${b.id}" src="${cover}" alt="Capa de ${b.title}">
        </div>
        <div class="card-body">
          <div class="card-title">${b.title}</div>
          <div class="card-sub">${b.author}</div>
          <div class="card-actions">
            <a class="btn btn-primary" href="leitura.html?id=${encodeURIComponent(b.id)}">Ler</a>
          </div>
        </div>
      </article>
    `;
  }

  function applyFilters(list) {
    let arr = list.slice();
    if (state.q) {
      const q = state.q.toLowerCase();
      arr = arr.filter(b =>
        (b.title  || '').toLowerCase().includes(q) ||
        (b.author || '').toLowerCase().includes(q)
      );
    }
    if (state.genre && state.genre !== 'Todos') {
      arr = arr.filter(b => (b.genres || []).includes(state.genre));
    }
    return arr;
  }

  function attachCoverFallback() {
    // se alguma capa falhar, troca pelo SVG temático
    grid.querySelectorAll('img[data-id]').forEach(img => {
      img.addEventListener('error', () => {
        const id = img.dataset.id;
        const b = BOOKS.find(x => x.id === id);
        if (b) img.src = generateCoverDataURL(b.title, b.author);
      }, { once: true });
    });
  }

  function renderGrid() {
    const list = applyFilters(BOOKS);
    grid.innerHTML = list.length
      ? list.map(cardHTML).join('')
      : `<p style="color:var(--muted)">Nenhum livro encontrado para os filtros atuais.</p>`;
    attachCoverFallback();
  }

  // Busca
  if (searchInput) {
    searchInput.addEventListener('input', () => {
      state.q = searchInput.value.trim();
      updateURL();
      renderGrid();
    });
  }

  renderChips();
  renderGrid();
</script>

</body>
</html>
